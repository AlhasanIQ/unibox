(function(a){a.fn.unibox=function(b){var d=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,extraHtml:undefined,minChars:3,maxWidth:d.outerWidth()},b);UniBox.init(d,c);return this}}(jQuery));var UniBox=function(){var e=-1;var j;var r;var z;var v="";var l="";var o;var f=[];var g=true;var c;var y=300;var n="";var p=2;var m;var u;var s=[];var q="all";var d=-1;function i(B){if(B!==undefined){var C=j.val();if(B.keyCode==9||B.keyCode==13||C.length<p){z.slideUp(y);if(B.keyCode==13&&m!=undefined&&e==-1){m.call(this,C)}e=-1}}else{z.slideUp(y);e=-1}}function h(C,B){var D=null;return function(){var F=this,E=arguments;clearTimeout(D);D=window.setTimeout(function(){C.apply(F,E)},B||50)}}function w(C,B){if(!g){return C}var E=B.split(" ");var D={};$.each(E,function(F,G){if(G.length<2){return}C=C.replace(new RegExp(G,"gi"),"##"+F+"##");D["##"+F+"##"]="<span>"+G+"</span>"});$.each(D,function(F,G){C=C.replace(new RegExp(F,"gi"),G)});return C}function A(E){if(d==13){i();return}var B=j.val();z.html("");var D=false;$.each(E.suggests,function(G,F){var I=$('<div class="unibox-suggest-'+G+'"></div>');if(G.replace(/_/,"").length>0&&F.length>0){var H=$("<h4>"+G+"</h4>");I.append(H)}$.each(F,function(R,P){var O='<div class="unibox-selectable">';if(P.image!=undefined){O+='<div class="unibox-selectable-img-container"><img src="'+P.image+'"/></div>'}if(P.link!=undefined){O+='<a href="'+P.link+'">';O+=w(P.name,B);O+="</a>"}else{O+="<span>"+w(P.name,B)+"</span>"}if(c!=undefined){var Q=c.match(/##(.*?)##/gi);var N=c;var L=false;for(var K in Q){var M=Q[K].replace(/#/g,"");var J=P[M];if(J==undefined){L=true;continue}var T=new RegExp(Q[K],"g");N=N.replace(T,J)}if(!L){O+='<div class="unibox-extra">'+N+"</div>"}}O+='<div class="unibox-ca"></div></div>';var S=$(O);I.append(S);D=true});z.append(I)});f=$(".unibox-selectable");e=-1;f.click(function(){var G=$(this).find("span").first().text();j.val(G);var F=undefined;try{F=$(this).find("a").attr("href")}catch(H){}u.call(this,G,F);i()});$(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(E.words.length>0&&n.length>0&&(q=="all"||q=="bottom")){z.append("<h4>"+n+"</h4>");D=true}var C=[];$.each(E.words,function(G,J){if((q=="all"||q=="bottom")){if(J.overlayImage!=undefined){z.append('<img class="unibox-vis" src="'+l+J.overlayImage+'" style="background-image: url(\''+l+J.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(J.image!=undefined){z.append('<img class="unibox-vis" src="'+l+J.image+'">')}}}var I=$("#unibox-invisible");I.html(B.replace(new RegExp(J.name,"gi"),"<span>"+J.name+"</span>"));if((q=="all"||q=="top")&&jQuery.inArray(J.image,s)==-1){var H=$("#unibox-invisible span")[0];if(H!=undefined&&J.name.length>0&&J.image!=undefined){var F=$(H).position().left;visImage=$('<div class="unibox-ivf"><img src="'+l+J.image+'" alt="'+J.name+'"></div>');visImage.css("left",x().left+F-10);visImage.css("top",x().top-j.outerHeight()-80);r.append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10);C.push(J.image)}}else{if(jQuery.inArray(J.image,s)>-1){C.push(J.image)}}});s=C;$("img").error(function(){$(this).hide()});z.css("left",x().left);z.css("top",x().top);if(D){z.slideDown(y,function(){z.css("left",x().left);z.css("top",x().top)})}else{i()}}function x(){return{left:j.offset().left-r.offset().left,top:j.offset().top-r.offset().top+j.outerHeight()}}function b(){var C=$(".unibox-ivf img").map(function(){return $(this).attr("src")}).get();for(var B=0;B<C.length;B++){if(jQuery.inArray(C[B].replace(l,""),s)==-1){$('.unibox-ivf:has(img[src*="'+C[B]+'"])').remove()}}}function a(){s=[];$(".unibox-ivf").remove()}function k(D){if(j.val().length<=1){a()}if(D.keyCode!=38&&D.keyCode!=40&&D.keyCode!=13){b();return}if(D.keyCode==38&&e>0){e--}else{if(D.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var C=$(f[e]);C.addClass("active")}if(D.keyCode==13){if(u!=undefined){var F=j.val();var B=undefined;if(e!=-1){F=$($(".unibox-selectable.active span")[0]).text();j.val(F);try{B=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(E){}}u.call(this,F,B)}else{if(e!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function t(B){d=B.keyCode;if(B.keyCode==38||B.keyCode==40||B.keyCode==13){return}var C=j.val();if(d==46&&C.length==0){a()}if(C.length>=p){$.ajax(v+encodeURIComponent(C),{dataType:"json",success:function(D){A(D)}})}}return{updateSuggestUrl:function(B){v=B},hideSuggestBox:function(){i()},setIvfImagePath:function(B){l=B;if(l.charAt(l.length-1)!="/"){l+="/"}},changeInstantVisualFeedbackState:function(B){q=B},init:function(E,B){j=E;r=j.parent();g=B.highlight;c=B.extraHtml;v=B.suggestUrl;l=B.ivfImagePath;o=B.throttleTime;y=B.animationSpeed;p=B.minChars;m=B.enterCallback;u=B.enterCallbackResult;q=B.instantVisualFeedback;n=B.queryVisualizationHeadline;j.attr("autocomplete","off");z=$('<div id="unibox-suggest-box"></div>');r.append(z);var F=r.css("position");if(F!="absolute"){j.parent().css("position","relative")}var C=z.css("border-width").replace("px","");z.css("min-width",j.outerWidth()-2*C);z.css("max-width",B.maxWidth-2*C);j.keydown(k);j.keydown(h(t,o));j.keyup(i);$("html").click(function(){z.slideUp(y)});z.click(function(G){G.stopPropagation()});var D=$('<div id="unibox-invisible">&nbps;<span>&nbsp;</span></div>');j.parent().append(D);if(q=="none"){$("#unibox-invisible").css("display","none")}}}}();